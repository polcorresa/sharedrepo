# T1.2: Schemas and Migrations - Implementation Summary

## âœ… Completed

All database schemas and migrations have been successfully defined and implemented.

## ğŸ“Š Database Tables

### Core Tables

1. **repos** - Repository metadata
   - Tracks slug, password, timestamps, and size
   - Expires after 7 days of inactivity
   - Cascade deletes all child data

2. **folders** - Folder tree structure
   - Self-referencing parent-child relationship
   - Optimistic concurrency via version field
   - Unique name constraint per parent

3. **files** - File metadata
   - Links to folders and repos
   - Tracks language, size, version
   - Unique name constraint per folder

4. **file_contents** - Saved file text
   - Separated from metadata for performance
   - One-to-one with files
   - Used for archive generation

5. **yjs_persistence** - CRDT snapshots (optional v1)
   - Stores Yjs document state
   - Enables server restart resilience
   - Key format: `repo:<id>:file:<id>`

6. **logs** - Debug and security logging
   - Minimal PII-free logging
   - Hashed IP addresses
   - Indexed for queries and cleanup

## ğŸ“ Files Created/Modified

### Migrations
- âœ… `packages/db/src/migrations/migrations/001_initial_schema.ts` (existed)
- âœ… `packages/db/src/migrations/migrations/002_add_logs_table.ts` (created)

### Type Definitions
- âœ… `packages/db/src/types.ts` (updated with Log types)
- âœ… `packages/db/src/index.ts` (updated exports)
- âœ… `packages/db/src/client.ts` (fixed import)

### Documentation
- âœ… `packages/db/SCHEMA.md` (comprehensive schema documentation)
- âœ… `packages/db/QUICK_REFERENCE.md` (developer quick reference)
- âœ… `packages/db/README.md` (updated with schema overview)

## ğŸ”‘ Key Features

### Optimistic Concurrency Control
- All tree nodes (folders/files) have `version` fields
- Operations must provide `expected_version`
- Server validates version before applying changes
- Prevents conflicting concurrent modifications

### Cascade Deletes
- Deleting a repo removes all associated data:
  - Folders â†’ Files â†’ File Contents
  - Yjs Persistence records
- Logs use SET NULL to preserve history

### Expiration System
- Repos expire 7 days after `last_accessed_at`
- Background job handles cleanup
- Slug becomes available for reuse

### Privacy & Security
- IP addresses are hashed before logging
- No personal identifiable information stored
- Passwords hashed with bcrypt/argon2
- Parameterized queries via Kysely (SQL injection safe)

## ğŸ” Type Safety

All tables have full TypeScript types:

```typescript
// Table interface
interface RepoTable { ... }

// Query result type
type Repo = Selectable<RepoTable>;

// Insert type
type NewRepo = Insertable<RepoTable>;

// Update type
type RepoUpdate = Updateable<RepoTable>;
```

## ğŸš€ Running Migrations

```bash
# From project root
pnpm --filter @sharedrepo/db run migrate

# Or from packages/db
cd packages/db
pnpm run migrate
```

## ğŸ“ Usage Example

```typescript
import { createDatabase, Repo, NewRepo } from '@sharedrepo/db';

const db = createDatabase(process.env.DATABASE_URL);

// Create repo
const newRepo: NewRepo = {
  slug: 'myproject',
  password_hash: await hash('password123'),
};

const repo: Repo = await db
  .insertInto('repos')
  .values(newRepo)
  .returningAll()
  .executeTakeFirstOrThrow();

// Query with joins and type safety
const filesWithContent = await db
  .selectFrom('files')
  .innerJoin('file_contents', 'file_contents.file_id', 'files.id')
  .select(['files.name', 'files.language_hint', 'file_contents.text'])
  .where('files.repo_id', '=', repo.id)
  .execute();
```

## ğŸ“‹ Schema Constraints

### Unique Constraints
- `repos.slug` - One repo per slug (when not expired)
- `folders(repo_id, parent_folder_id, name)` - No duplicate folder names
- `files(repo_id, folder_id, name)` - No duplicate file names

### Foreign Keys
All with appropriate cascade rules:
- `folders.repo_id` â†’ `repos.id` (CASCADE)
- `folders.parent_folder_id` â†’ `folders.id` (CASCADE)
- `files.repo_id` â†’ `repos.id` (CASCADE)
- `files.folder_id` â†’ `folders.id` (CASCADE)
- `file_contents.file_id` â†’ `files.id` (CASCADE)
- `logs.repo_id` â†’ `repos.id` (SET NULL)

### Indexes
Performance-critical indexes:
- `repos_slug_idx` - Fast slug lookups
- `repos_last_accessed_at_idx` - Expiry queries
- `logs_timestamp_idx` - Log queries and cleanup
- `logs_repo_id_idx` - Repo-specific logs

## ğŸ¯ Next Steps

The database schema is ready for:
1. Repository CRUD operations (T1.3)
2. Tree management APIs (T2)
3. Real-time collaboration (T3)
4. Expiration jobs (T4)
5. Logging and monitoring (T5)

## âœ… Verification

- Type checking: âœ… Passes
- Migrations: âœ… Ready to run
- Documentation: âœ… Complete
- Exports: âœ… All types exported
