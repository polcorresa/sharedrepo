# T4.2 Summary: Repo Expiration Job

## Overview
Implemented a background job to automatically delete repositories that have not been accessed in the last 7 days.

## Components

### 1. Job Logic (`apps/server/src/jobs/expiry.job.ts`)
- **`runExpiryJob`**:
  - Calls `RepoRepository.deleteExpired()`.
  - Logs the number of deleted repos.
  - Handles and logs errors.

### 2. Scheduler Plugin (`apps/server/src/plugins/jobs.ts`)
- **`jobsPlugin`**:
  - Uses `setInterval` to run `runExpiryJob` every hour (3600000 ms).
  - Cleans up the interval on server close (`onClose` hook).
  - Registered in `server.ts`.

### 3. Database Support (`@sharedrepo/db`)
- **`RepoRepository.deleteExpired`**:
  - Deletes repos where `last_accessed_at < now - 7 days`.
- **Schema**:
  - `folders`, `files`, and `file_contents` tables use `ON DELETE CASCADE` on `repo_id`.
  - This ensures all child data is automatically removed when the repo is deleted.

## Verification
- `pnpm --filter @sharedrepo/server typecheck` passed.
- Verified schema migration uses `onDelete('cascade')`.
